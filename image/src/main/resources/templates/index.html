<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Learning Spring Boot: Spring-a-Gram</title>
    <link href="/main.css" rel="stylesheet"/>
</head>
<body>
<h1>Learning Spring Boot - 2nd Edition</h1>
<h3>Using LiveReload plugin in your browser will speed up your efforts</h3>
<h3>It's really handy to make edits to local files to go out to cloud automatically.</h3>
<h4 th:text="${extra}"/>
<div>
    <span th:text="${auth.name}"/>
    <span th:text="${auth.authorities}"/>
</div>
<hr>
<div>
    <table>
        <thead>
        <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Image</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="image : ${images}">
            <td th:text="${image.id}"/>
            <td th:text="${image.name}"/>
            <td>
                <a th:href="@{'/images/' + ${image.name} + '/raw'}">
                    <img class="thumbnail"
                         th:src="@{'/images/'+${image.name}+'/raw'}"/>
                </a>
            </td>
            <td>
                <form th:action="@{'/images/' + ${image.name}}"
                      th:method="delete">
                    <input type="submit" value="Delete"/>
                </form>
            </td>
            <td th:text="${image.owner}">

            </td>
            <td>
                <ul th:id="'ul-comment-' + ${image.id}">
                    <li th:each="comment: ${image.comments}"
                        th:text="${comment.comment}"></li>
                </ul>
            </td>
            <td>
                <input th:id="'comment-' + ${image.id}" type="text" value=""/>
                <button class="comment" th:id="${image.id}">Submit</button>
            </td>
        </tr>
        </tbody>
    </table>
    <form action="/images" enctype="multipart/form-data"
          method="post">
        <p><input name="file" type="file"/></p>
        <p><input type="submit" value="Upload"/></p>
    </form>
</div>

<div id="checkBox">
    Greetings!
    <br/>
    <textarea cols="80" disabled="true" id="chatDisplay" rows="10"></textarea>
    <br/>
    <input id="chatBox" style="width:500px;" type="text" value=""/>
    <br/>
    <button id="chatButton">Send</button>
    <br/>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    (function () {

        var newCommentSocket;

        var outboundChatWebsocket;

        var inboundChatWebsocket;

        document.querySelectorAll('button.comment')
            .forEach(function (button) {
                console.log('Registry click event for button', button.id);
                button.addEventListener('click', function () {
                    var comment = document.getElementById('comment-' + button.id);
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST',/*[[@{'/image/comments'}]]*/'', true);

                    var formData = new FormData();
                    formData.append('comment', comment.value);
                    formData.append('imageId', button.id);
                    xhr.send(formData);

                    comment.value = '';
                });
            });

        newCommentSocket = new WebSocket('ws://localhost:8200/topic/comment.new');
        newCommentSocket.onopen = function () {
            console.log('Connected to comment service');
        }

        newCommentSocket.onmessage = function (event) {
            console.log('Received ' + event.data + '!');
            var passedMessage = JSON.parse(event.data);

            var ul = document.getElementById('ul-comment-' + passedMessage.imageId);
            var li = document.createElement('li');
            li.appendChild(document.createTextNode(passedMessage.comment));
            ul.appendChild(li);
        };

        outboundChatWebsocket = new WebSocket('ws://localhost:8200/app/chatMessage.new');
        outboundChatWebsocket.onopen = function () {
            console.log('Connected to send message service');
            document.getElementById('chatButton')
                .addEventListener('click', function () {
                    var chatBox = document.getElementById('chatBox');
                    console.log('Publishing "' + chatBox.value + '"');
                    outboundChatWebsocket.send(chatBox.value);
                    chatBox.value = '';
                    chatBox.focus();
                });
        };

        inboundChatWebsocket = new WebSocket('ws://localhost:8200/topic/chatMessage.new');
        inboundChatWebsocket.onopen = function () {
            console.log('Connected to rec message service');

        };
        inboundChatWebsocket.onmessage = function (event) {
            console.log('Received ' + event.data);
            var chatDisplay = document.getElementById('chatDisplay');
            chatDisplay.value = chatDisplay.value + event.data + '\n';
        };

    })();
    /*]]*/
</script>
</body>
</html>